
<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="sasano8's portfolio">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-7.3.0">
    
    
      
        <title>SQL - sasano8</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8b42a75e.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
      <link rel="stylesheet" href="../../overrides/css/custom.css">
    
      <link rel="stylesheet" href="https://unpkg.com/mermaid@8.0.0/dist/mermaid.css">
    
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="green" data-md-color-accent="deep-orange">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sql" class="md-skip">
          コンテンツにスキップ
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="ヘッダー">
    <a href="../.." title="sasano8" class="md-header__button md-logo" aria-label="sasano8" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            sasano8
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SQL
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="" data-md-color-primary="green" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="検索" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="クリア" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            検索を初期化
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="ナビゲーション" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="sasano8" class="md-nav__button md-logo" aria-label="sasano8" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    sasano8
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        はじめに
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../standard_spec/" class="md-nav__link">
        標準仕様
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          セキュリティ
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="セキュリティ" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          セキュリティ
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/auth/" class="md-nav__link">
        権限
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/osint/" class="md-nav__link">
        オシント
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        アーキテクチャ
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../database/" class="md-nav__link">
        データベース
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../visualization/" class="md-nav__link">
        ビジュアライズ
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../test/" class="md-nav__link">
        テスト
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          プログラム言語
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="プログラム言語" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          プログラム言語
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../vba/" class="md-nav__link">
        VBA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../javascript/" class="md-nav__link">
        JavaScript
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          SQL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        SQL
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#with" class="md-nav__link">
    WITH句 について
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#union" class="md-nav__link">
    UNION について
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#over" class="md-nav__link">
    OVER句 について
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    累積値を単月値に戻す
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pivot" class="md-nav__link">
    Pivotについて
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unpivot" class="md-nav__link">
    UnPivotについて
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql_1" class="md-nav__link">
    動的SQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    カーソル操作
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../parsing/" class="md-nav__link">
        構文解析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          要件定義
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="要件定義" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          要件定義
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../requirements/management/" class="md-nav__link">
        マネジメント
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../requirements/functional/" class="md-nav__link">
        機能要件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../requirements/non_functional/" class="md-nav__link">
        非機能要件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../requirements/design/" class="md-nav__link">
        設計
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../awasome_api/" class="md-nav__link">
        awasome api
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../math/" class="md-nav__link">
        数学
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" type="checkbox" id="__nav_12" >
      
      
      
      
        <label class="md-nav__link" for="__nav_12">
          tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="tools" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/tmux/" class="md-nav__link">
        tmux
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../print_page/" class="md-nav__link">
        印刷用ページ
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#with" class="md-nav__link">
    WITH句 について
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#union" class="md-nav__link">
    UNION について
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#over" class="md-nav__link">
    OVER句 について
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    累積値を単月値に戻す
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pivot" class="md-nav__link">
    Pivotについて
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unpivot" class="md-nav__link">
    UnPivotについて
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql_1" class="md-nav__link">
    動的SQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    /*
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    カーソル操作
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              

    <a href="../../print_page/" title="印刷用ページ" class="md-content__button md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 3H6v4h12m1 5a1 1 0 0 1-1-1 1 1 0 0 1 1-1 1 1 0 0 1 1 1 1 1 0 0 1-1 1m-3 7H8v-5h8m3-6H5a3 3 0 0 0-3 3v6h4v4h12v-4h4v-6a3 3 0 0 0-3-3z"/></svg>
    </a>




                
                
                <h1 id="sql">SQL</h1>
<p>``` sql
/<em>
SQL TRANING.
</em>/</p>
<h2 id="_1">/*</h2>
<h2 id="with">WITH句 について</h2>
<p>SQLSERVERなどで利用可能な構文。
CTE(Common Table Expression:共通テーブル SQL99規格）と呼ばれ、再帰などに利用する。
ノードを辿るのに用いられる
*/</p>
<p>-- DECLARE @NODES TABLE(Id int, Location VARCHAR(10), Parent VARCHAR(10));</p>
<p>-- prefixを#とすると、一時テーブルとなる。##でグローバル一時テーブルになる
-- テーブルはセッション終了時に削除される。</p>
<p>DROP TABLE IF EXISTS #NODES;
CREATE TABLE #NODES(
     Id int,
     Location VARCHAR(10),
     Parent VARCHAR(10)
);</p>
<p>INSERT INTO #NODES
        select 1 as Id, 'Universe' as Location, '' as Parent
union all   select 2 as Id, 'Mars' as Location, 'Universe' as Parent
union all   select 3 as Id, 'Earth' as Location, 'Universe' as Parent
union all   select 4 as Id, 'America' as Location, 'Earth' as Parent
union all   select 5 as Id, 'Japan' as Location, 'Earth' as Parent
union all   select 6 as Id, 'Tokyo' as Location, 'Japan' as Parent
union all   select 7 as Id, 'Osaka' as Location, 'Japan' as Parent
;</p>
<p>SELECT * FROM #NODES;</p>
<p>DECLARE @Tagert Varchar(10);
SET @Tagert = 'Japan';</p>
<p>WITH LOOP_TABLE AS (</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">#NODES</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">#NODES</span><span class="p">.</span><span class="n">Location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">@Tagert</span><span class="w"></span>
<span class="ow">UNION</span><span class="w"> </span><span class="ow">ALL</span><span class="w"></span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">#NODES</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">LOOP_TABLE</span><span class="p">,</span><span class="w"> </span><span class="n">#NODES</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">LOOP_TABLE</span><span class="p">.</span><span class="n">Parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">#NODES</span><span class="p">.</span><span class="n">Location</span><span class="w"> </span><span class="c1">-- 親の定義を階層定義から取得　取得分が次のループとなる</span>
</code></pre></div>

<p>)</p>
<p>SELECT * FROM LOOP_TABLE;</p>
<h2 id="_2">/*</h2>
<h2 id="union">UNION について</h2>
<p>union は足し算と考えればよい
*/</p>
<p>-- 重複を許す
select 1,'test1' union all
select 1,'test1' union all
select 3,'test3'</p>
<p>-- 重複を許さない　重複チェックがある分、速度が遅い
select 1,'test1' union
select 1,'test1' union
select 3,'test3'</p>
<h2 id="_3">/*</h2>
<h2 id="over">OVER句 について</h2>
<p>集約関数をOVER句とともに利用することで、
移動平均、累積集計、集計途中経過などを算出することができる。
*/
DECLARE @T1 TABLE(Center VARCHAR(10), Period VARCHAR(2),Val int);</p>
<p>INSERT INTO @T1
            select 'C01' as Center, '01' as Period, 1 as Val
union all   select 'C01' as Center, '02' as Period, 1 as Val
union all   select 'C01' as Center, '03' as Period, 1 as Val
union all   select 'C01' as Center, '04' as Period, 1 as Val
union all   select 'C01' as Center, '05' as Period, 1 as Val
union all   select 'C01' as Center, '06' as Period, 1 as Val
union all   select 'C01' as Center, '07' as Period, 1 as Val
union all   select 'C01' as Center, '08' as Period, 1 as Val
union all   select 'C01' as Center, '09' as Period, 1 as Val
union all   select 'C01' as Center, '10' as Period, 1 as Val
union all   select 'C01' as Center, '11' as Period, 1 as Val
union all   select 'C01' as Center, '12' as Period, 1 as Val
union all   select 'C02' as Center, '01' as Period, 1 as Val
union all   select 'C02' as Center, '02' as Period, 1 as Val
union all   select 'C02' as Center, '03' as Period, 1 as Val
union all   select 'C02' as Center, '04' as Period, 1 as Val
union all   select 'C02' as Center, '05' as Period, 1 as Val
union all   select 'C02' as Center, '06' as Period, 1 as Val
union all   select 'C02' as Center, '07' as Period, 1 as Val
union all   select 'C02' as Center, '08' as Period, 1 as Val
union all   select 'C02' as Center, '09' as Period, 1 as Val
union all   select 'C02' as Center, '10' as Period, 1 as Val
union all   select 'C02' as Center, '11' as Period, 1 as Val
union all   select 'C02' as Center, '12' as Period, 1 as Val;</p>
<p>-- Center毎の毎月の計上値を累計表示にする
INSERT INTO @T2
select Center, SUM(Val) OVER(Partition by Center order by Period) FROM @T1;</p>
<p>select * FROM @T2;</p>
<h2 id="_4">/*</h2>
<h2 id="_5">累積値を単月値に戻す</h2>
<p>LAG（対象列、何行前を取得するか、Nullの場合の値）を利用して、累積値を単月値に戻す。
*/
Select Center, Period, Val - LAG(Val,1,0) OVER(Partition by Center order by Period ASC) FROM @T2;</p>
<h2 id="_6">/*</h2>
<h2 id="pivot">Pivotについて</h2>
<p>行を列に変換する。
*/</p>
<p>DECLARE @T4 TABLE(ID int, Country VARCHAR(10), Product VARCHAR(10),AMOUNT int);</p>
<p>INSERT INTO @T4
          select 1 as ID, 'Japan'   as Country, 'TV'    as Product, 100 as AMOUNT
union all select 2 as ID, 'Japan'   as Country, 'Phone' as Product, 200 as AMOUNT
union all select 3 as ID, 'America' as Country, 'TV'    as Product, 300 as AMOUNT
union all select 4 as ID, 'America' as Country, 'Phone' as Product, 400 as AMOUNT
union all select 5 as ID, 'Jamaica' as Country, 'TV'    as Product, 500 as AMOUNT
;</p>
<p>SELECT * FROM @T4;</p>
<p>select * FROM @T4
PIVOT(
SUM(AMOUNT) FOR Product IN(TV,Phone)
) AS PV;</p>
<h2 id="_7">/*</h2>
<h2 id="unpivot">UnPivotについて</h2>
<p>列を行に変換する。
*/
DECLARE @T5 TABLE(TV VARCHAR(10), Phone VARCHAR(10));</p>
<p>INSERT INTO @T5
          select 100, 200 as Amount
union all select 200, 300 as Amount
union all select 400, 500 as Amount
union all select null, 300 as Amount
union all select 200, null as Amount
union all select null, null as Amount
;</p>
<p>SELECT * FROM @T5;</p>
<p>SELECT Product,Amount FROM @T5
UNPIVOT(
Amount FOR Product IN (TV,Phone)
) AS UP;</p>
<p>-- カタログビューとは？
-- Pivot,Unpivotは値が変わると動的に取得することができない。
-- そのため、工夫が必要。https://www.casleyconsulting.co.jp/blog/engineer/162/</p>
<h2 id="_8">/*</h2>
<h2 id="sql_1">動的SQL</h2>
<p>*/
exec sp_executesql "select 1";
-- exec sp_executesql 'select 1'; -- 実行不可</p>
<h2 id="_9">/*</h2>
<h2 id="_10">カーソル操作</h2>
<p>*/</p>
<p>-- カーソル定義
DECLARE CUR_TABLES CURSOR FOR
  SELECT sys.tables.object_id,sys.tables.name
  FROM sys.tables
  INNER JOIN sys.objects
  ON sys.tables.object_id = sys.objects.object_id
;</p>
<p>DECLARE @CUR_T TABLE(object_id VARCHAR(100),table_name VARCHAR(100),ODD VARCHAR(100));</p>
<p>DECLARE @object_id VARCHAR(100);
DECLARE @table_name VARCHAR(100);</p>
<p>-- カーソルオープン
OPEN  CUR_TABLES;</p>
<p>-- データを格納
FETCH NEXT FROM CUR_TABLES
INTO @object_id,@table_name
;</p>
<p>-- カーソルのデータが終わるまで繰り返す（この実装はややださい。WHILE 1 = 1 で無限ループさせ、FETCH_STATUSを中で確認し、FETCH文を一か所にしか登場させない実装もある。）
WHILE @@FETCH_STATUS = 0
BEGIN</p>
<div class="highlight"><pre><span></span><code><span class="o">--</span><span class="w"> </span><span class="n">IFの構文はBEGIN</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ENDを定義するが</span><span class="err">、</span><span class="n">省略可能</span><span class="w"></span>
<span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="nv">@object_id</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="k">BEGIN</span><span class="w"></span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="nv">@CUR_T</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="nv">@object_id</span><span class="p">,</span><span class="nv">@table_name</span><span class="p">,</span><span class="s1">&#39;fizzbuzz&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="k">END</span><span class="w"></span>
<span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="nv">@object_id</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="k">BEGIN</span><span class="w"></span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="nv">@CUR_T</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="nv">@object_id</span><span class="p">,</span><span class="nv">@table_name</span><span class="p">,</span><span class="s1">&#39;fizz&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="k">END</span><span class="w"></span>
<span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="nv">@object_id</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="k">BEGIN</span><span class="w"></span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="nv">@CUR_T</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="nv">@object_id</span><span class="p">,</span><span class="nv">@table_name</span><span class="p">,</span><span class="s1">&#39;buzz&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="k">END</span><span class="w"></span>
<span class="k">ELSE</span><span class="w"></span>
<span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="k">BEGIN</span><span class="w"></span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="nv">@CUR_T</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="nv">@object_id</span><span class="p">,</span><span class="nv">@table_name</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="k">END</span><span class="w"></span>

<span class="k">FETCH</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">CUR_TABLES</span><span class="w"></span>
<span class="k">INTO</span><span class="w"> </span><span class="nv">@object_id</span><span class="p">,</span><span class="nv">@table_name</span><span class="w"></span>
</code></pre></div>

<p>END</p>
<p>-- カーソルクローズ
CLOSE CUR_TABLES;</p>
<p>-- メモリを解放する
DEALLOCATE CUR_TABLES;</p>
<p>-- 結果の確認
SELECT * FROM @CUR_T;
```</p>
                
              

              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="フッター">
      
        
        <a href="../javascript/" class="md-footer__link md-footer__link--prev" aria-label="前: JavaScript" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                前
              </span>
              JavaScript
            </div>
          </div>
        </a>
      
      
        
        <a href="../parsing/" class="md-footer__link md-footer__link--next" aria-label="次: 構文解析" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                次
              </span>
              構文解析
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8263e09.min.js", "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\u3000\u3001\u3002\uff0c\uff0e]+", "search.placeholder": "\u691c\u7d22", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version.title": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.4fc53ad4.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.0.0/dist/mermaid.min.js"></script>
      
    
  </body>
</html>